# ============================================
# Docker Compose - Système de Tickets Support
# ============================================
# 
# Architecture: 4 services interconnectés
# - db: PostgreSQL 16 (base de données)
# - app: PHP 8.3-FPM + Symfony 7.2 (backend API)
# - nginx: Serveur web (reverse proxy)
# - frontend: Node 20 + Vite (dev server Vue.js)
#
# Network: tickets_network (bridge interne)
# Volumes: postgres_data (persistance BDD)
#
# URLs d'accès:
# - Frontend: http://localhost:5173
# - Backend API: http://localhost:8000
# - PostgreSQL: localhost:5433
# ============================================

version: '3.8'

services:
  # ==========================================
  # SERVICE: Base de données PostgreSQL
  # ==========================================
  db:
    image: postgres:16-alpine
    container_name: tickets_db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-tickets}
      POSTGRES_USER: ${POSTGRES_USER:-symfony}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-symfony}
    ports:
      # Port 5433 externe pour éviter conflit avec PostgreSQL local
      - "5433:5432"
    volumes:
      # Volume persistant pour ne pas perdre les données
      - postgres_data:/var/lib/postgresql/data
    networks:
      - tickets_network
    healthcheck:
      # Vérifie que PostgreSQL est prêt avant de démarrer les autres services
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-symfony}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # SERVICE: Backend Symfony (PHP-FPM)
  # ==========================================
  app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: tickets_app
    working_dir: /var/www/html
    ports:
      # Port 8000 exposé directement (serveur PHP intégré)
      - "8000:8000"
    volumes:
      # Volume partagé pour le code source (hot reload)
      - ./backend:/var/www/html
      # Volume Docker séparé pour vendor (évite problèmes I/O Windows)
      - vendor_data:/var/www/html/vendor
      # Volume Docker séparé pour cache (évite problèmes I/O Windows)
      - cache_data:/var/www/html/var/cache
    networks:
      - tickets_network
    depends_on:
      db:
        # Attend que PostgreSQL soit healthy avant de démarrer
        condition: service_healthy
    environment:
      # DATABASE_URL utilisée par Doctrine
      # @db = nom du service Docker (résolution DNS interne)
      DATABASE_URL: "postgresql://${POSTGRES_USER:-symfony}:${POSTGRES_PASSWORD:-symfony}@db:5432/${POSTGRES_DB:-tickets}?serverVersion=16&charset=utf8"
      APP_ENV: dev
    # Healthcheck pour s'assurer que l'init est terminé
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/.init-done || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    # Utiliser le serveur PHP intégré avec le router custom
    command: php -S 0.0.0.0:8000 -t public/ public/router.php

  # ==========================================
  # SERVICE: Serveur web Nginx (DÉSACTIVÉ - utiliser PHP intégré)
  # ==========================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: tickets_nginx
  #   ports:
  #     # Port 8000 pour l'API REST
  #     - "8000:80"
  #   volumes:
  #     # Code source Symfony pour servir les assets
  #     - ./backend:/var/www/html
  #     # Configuration Nginx custom (FastCGI + CORS)
  #     - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
  #   networks:
  #     - tickets_network
  #   depends_on:
  #     # Nginx communique avec PHP-FPM via le réseau Docker
  #     - app

  # ==========================================
  # SERVICE: Frontend Vue.js + Vite
  # ==========================================
  frontend:
    build:
      context: .
      dockerfile: docker/node/Dockerfile
    container_name: tickets_frontend
    working_dir: /app
    ports:
      # Port 5173 pour le dev server Vite
      - "5173:5173"
    volumes:
      # Volume partagé pour le code source (hot reload)
      - ./frontend:/app
      # Volume anonyme pour node_modules (évite problèmes permissions Windows)
      - /app/node_modules
    networks:
      - tickets_network
    environment:
      # URL de l'API backend pour les appels Axios
      - VITE_API_URL=http://localhost:8000
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    # Note: npm install à chaque démarrage pour gérer les dépendances
    #       --host 0.0.0.0 permet l'accès depuis l'hôte Windows

  # ==========================================
  # SERVICE: pgAdmin (Interface PostgreSQL)
  # ==========================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: tickets_pgadmin
    environment:
      # Credentials pgAdmin (à changer en production)
      PGADMIN_DEFAULT_EMAIL: admin@tickets.com
      PGADMIN_DEFAULT_PASSWORD: admin
      # Désactive le mode serveur pour dev local
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      # Port 5050 pour l'interface web pgAdmin
      - "5050:80"
    networks:
      - tickets_network
    depends_on:
      - db
    volumes:
      # Persistance de la configuration pgAdmin
      - pgadmin_data:/var/lib/pgadmin

# ==========================================
# NETWORKS
# ==========================================
networks:
  tickets_network:
    driver: bridge
    # Network interne pour communication inter-services

# ==========================================
# VOLUMES
# ==========================================
volumes:
  postgres_data:
    # Volume Docker géré pour persistance PostgreSQL
  pgadmin_data:
    # Volume Docker géré pour persistance pgAdmin
  vendor_data:
    # Volume Docker géré pour dépendances Composer (évite I/O Windows)
  cache_data:
    # Volume Docker géré pour cache Symfony (évite I/O Windows)
    # Volume Docker géré pour persistance configuration pgAdmin
